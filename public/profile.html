<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Profile</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/7.1.0/firebase-app.js"></script>
    <script defer src="/__/firebase/7.2.2/firebase-firestore.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/7.1.0/firebase-auth.js"></script>
    <script defer src="/__/firebase/7.1.0/firebase-database.js"></script>
    <script defer src="/__/firebase/7.1.0/firebase-messaging.js"></script>
    <script defer src="/__/firebase/7.1.0/firebase-storage.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>

    <style media="screen">
      body { background: #ECEFF1; color: rgba(0,0,0,0.87); font-family: Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
      #message { background: white; max-width: 360px; margin: 100px auto 16px; padding: 32px 24px; border-radius: 3px; }
      #message h2 { color: #ffa100; font-weight: bold; font-size: 16px; margin: 0 0 8px; }
      #message h1 { font-size: 22px; font-weight: 300; color: rgba(0,0,0,0.6); margin: 0 0 16px;}
      #message p { line-height: 140%; margin: 16px 0 24px; font-size: 14px; }
      #message a { display: block; text-align: center; background: #039be5; text-transform: uppercase; text-decoration: none; color: white; padding: 16px; border-radius: 4px; }
      #message, #message a { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
      #load { color: rgba(0,0,0,0.4); text-align: center; font-size: 13px; }
      #people-card {margin: 20px;}
      #my-connections {margin: 20px;}
      #user_history {margin: 20px;}
      @media (max-width: 600px) {
        body, #message { margin-top: 0; background: white; box-shadow: none; }
        body { border-top: 16px solid #ffa100; }
      }
    </style>
  </head>

  <body>

    <!-- Sign-in/out box  -->
    <div id="message">
      <h2 id="currentUser">Hello </h2>
      <h5 id="profilePage"></h5>
      <button id="sign-in" onclick="signIn()">
      	Sign-in
      </button>
      <button id="sign-out" onclick="signOut()" hidden>
      	Sign-out
      </button>
      <hr>
    </div>
      
    <!--
    NOTE: Because our system isn't fully functional yet due to issues with <thead>
      database, there is information typed in manually that would be pulled from
      the database if all goes according to plan, which will be noted with comments
      underneath the respective lines of code. We wanted to include these in order
      to get a better sense of what our site would look like later.
    -->

    <!-- Information about the user -->
    <!-- inputs put in before the <span id> are to be deleted; just to get
    a sense of the kind of information that would be displayed-->
    <div id="people-card">
      <br>
        Name: <span id="name"></span>
      <!--<p>
      User ID:  <span id="user-id"></span>-->
      <button id="following" onclick="follow()">Follow</button>
      <p>
        Profession: <span id="profession"></span>
      <p>
        Connections: <span id="connection_count"></span>
      <p>
        Date Joined: <span id="date_joined"></span>
    </div>
    
    <!-- need to get this part to work!!! -->
    <div id="my-connections">
      <p>
        My Connection List: <span id="connection"></span>
    </div>
<!--    <div>
        <form>
            Enter Information to be Added to the Firestore Database:
            <input id="dataAddedByUser" type="text" name="dataForFirestore">
        </form> 
    </div>-->
      
        <!-- ******************************************* -->

    <div id="user_history">
      <br>
      <h2> Wendy's History </h2>
      <!-- this is an example post of what the activity feed might look like.
      once we restructure the database, we will get a better sense of where/how
      this information will be stored -->

      <h3> Oct. 28, 2019 </h3>
      <h4> Daily Article for October 28th, 2019: </h4>
      <!-- will incorportate date pulled from daily_article -->
      <h4> "Shooting in Sydney Raises Questions About Gun Control"</h4>
      <!-- will incorportate title pulled from daily_article -->
      <h5> by Damien Cave (New York Times) </h5>
      <!-- will incorportate author, source pulled from daily_article -->

      <!-- in our final design, these won't be buttons but rather symbols (for now, buttons) --> 
      <button id="react1">
      	Got Me Thinkin'
      </button>

      <button id="react2">
      	Right On Target
      </button>
    </div>

    <script>

      //sign in and out functions
      function signIn() {
        var provider = new firebase.auth.GoogleAuthProvider();
        firebase.auth().signInWithPopup(provider);
      }

      function signOut() {
        firebase.auth().signOut();
      }
        
//      function follow() {
//          var db = firebase.firestore(); //need this to access our database
//          const increment = firebase.firestore.FieldValue.increment(1);
//          var vals = window.location.search.split("="); //split profile html to grab user's id
//          db.collection("users").doc(vals[1]).onSnapshot(function (doc) {
//              var count = doc.data().connection_count;
//              var currentUser = firebase.auth().currentUser.uid;
//              //doc.update({user_connections: {count: currentUser}})
//              //doc.data().user_connections.update({count: currentUser})
//              doc.update({user_connections: firebase.firestore.FieldValue.arrayUnion(currentUser)});
//              doc.update({count: increment});
//          });
//      }
        
      function follow() {
          var db = firebase.firestore(); //need this to access our database
          var vals = window.location.search.split("="); //split profile html to grab user's id
          //person current user wants to follow
          var followRef = db.collection("users").doc(vals[1]);
          //current user info
          var currentUserID = firebase.auth().currentUser.uid;
          var currentUserRef = db.collection("users").doc(currentUserID);
          
          const increment = firebase.firestore.FieldValue.increment(1); 
          
//          //updating follower database
//          followRef.update({user_connections: firebase.firestore.FieldValue.arrayUnion(currentUserID)});
//          followRef.update({connection_count: increment});
          
          //updating current user database
          currentUserRef.update({user_connections: firebase.firestore.FieldValue.arrayUnion(vals[1])});
          currentUserRef.update({connection_count: increment});
        }
                
        
//      function unfollow() {
//          
//      }
        
      //where the magic happens
      document.addEventListener('DOMContentLoaded', function() {
        firebase.auth().onAuthStateChanged(authStateObserver);
        var db = firebase.firestore(); //need this to access our database

        var vals = window.location.search.split("="); //split profile html to grab user's id
        db.collection("users").doc(vals[1]).onSnapshot(function (doc) {
          document.getElementById("name").innerHTML = doc.data().username;
          //document.getElementById("user-id").innerHTML = doc.data().user_id;
          document.getElementById("profession").innerHTML = doc.data().profession;
          document.getElementById("connection_count").innerHTML = doc.data().connection_count;
          document.getElementById("date_joined").innerHTML = (doc.data().date_joined).toDate();
        });

        //trying to get the user_connections from the subcollection of user_connections
        //may have to switch to a map/array in the user's document instead
        db.collection("users").doc(vals[1]).onSnapshot(function (querySnapshot) {
            
            querySnapshot.data().user_connections.forEach(function(docs) {
                //document.getElementById("connection").innerHTML += "<p>" + docs + "</p>";
                db.collection("users").doc(docs).onSnapshot(function(newDoc) {
                    document.getElementById("connection").innerHTML += "<p>" + "<a href='profile.html?id="+newDoc.data().user_id+"'>" + newDoc.data().username +"</a>" + "</p>";
          });
            })
            
        })
          
        /*collection("user_details").get().then(function(querySnapshot) {
          querySnapshot.forEach(function(docs) {
            // doc.data() is never undefined for query doc snapshots
            //console.log(doc.id, " => ", doc.data());
            user_info = docs.collection("user_connections");
            db.doc(user_info).onSnapshot(function(newQuerySnapshot) {
                name = newQuerySnapshot.data().username;
                document.getElementById("connection").innerHTML += "<p>" + name + "</p>";
            })
          });
        });*/

        try {
          let app = firebase.app()
          let features = ['auth', 'database', 'messaging', 'storage'] .filter(feature => typeof app[feature] === 'function');
        } catch (e) {
          console.error(e);
        }
      });

      function authStateObserver(user) {
        if (user) { // User is signed in!
          document.getElementById("sign-in").hidden = true;
          document.getElementById("sign-out").hidden = false;

          //personalize the welcome screen with user's name
          var currentUser = firebase.auth().currentUser.displayName;
          document.getElementById("currentUser").innerHTML = "Welcome " + currentUser;
          var profilePage = document.getElementById("profilePage");

          var db = firebase.firestore();
          document.getElementById("profilePage").hidden = false;

          //link to the user's profile - do we need this?
          db.collection("users").doc(firebase.auth().currentUser.uid).onSnapshot(function(document) {
            profilePage.innerHTML = "<a href='profile.html?id="+document.data().user_id+"'>" + document.data().username +"</a>"
          });
            
          /*var formData = document.getElementById("dataAddedByUser").value;
          var dbRef = db.collection("users").doc(firebase.auth().currentUser.uid);
            dbRef.update({
                username: formData,
            });
            */
          document.getElementById("people-card").hidden = false;

        } else { // User is signed out!
          document.getElementById("sign-in").hidden = false;
          document.getElementById("sign-out").hidden = true;
          //show generic welcome page, not customized
          document.getElementById("currentUser").innerHTML = "Welcome! Please sign in";
          document.getElementById("profilePage").hidden = true;
          document.getElementById("people-card").hidden = true;
        }
      }

    </script>
  </body>
</html>
