<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Who Cares: Profile</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    <!-- update the version number as needed -->
    <script defer src="/__/firebase/7.1.0/firebase-app.js"></script>
    <script defer src="/__/firebase/7.2.2/firebase-firestore.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/7.1.0/firebase-auth.js"></script>
    <script defer src="/__/firebase/7.1.0/firebase-database.js"></script>
    <script defer src="/__/firebase/7.1.0/firebase-messaging.js"></script>
    <script defer src="/__/firebase/7.1.0/firebase-storage.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>


  </head>

  <body class="profPage">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="#">Who Cares</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav">
          <a class="nav-item nav-link active" href="https://cs323-kiak.firebaseapp.com">Home <span class="sr-only">(current)</span></a>
          <a class="nav-item nav-link" href="https://cs323-kiak.firebaseapp.com/profile">Profile</a>
          <a class="nav-item nav-link" href="https://cs323-kiak.firebaseapp.com/connections">Connections</a>
          <a class="nav-item nav-link" href="https://cs323-kiak.firebaseapp.com/bookmarks">Bookmarks</a>
          <a class="nav-item nav-link" href="https://cs323-kiak.firebaseapp.com/dots">Dots</a>
          <a class="nav-item nav-link" href="https://cs323-kiak.firebaseapp.com/about">About</a>
        </div>
      </div>
    </nav>

  <div id = profileMargin>
    <!-- Sign-in/out box  -->
    <div id="message">
      <h2 id="currentUser">Hello, </h2>
      <h5 id="profilePage"></h5>
      <button id="sign-in" onclick="signIn()">
      	Sign-in
      </button>
      <button id="sign-out" onclick="signOut()" hidden>
      	Sign-out
      </button>
      <hr>
    </div>

    <!--
    NOTE: Because our system isn't fully functional yet due to issues with <thead>
      database, there is information typed in manually that would be pulled from
      the database if all goes according to plan, which will be noted with comments
      underneath the respective lines of code. We wanted to include these in order
      to get a better sense of what our site would look like later.
    -->

    <!-- Information about the user -->
    <!-- inputs put in before the <span id> are to be deleted; just to get
    a sense of the kind of information that would be displayed-->

      <div id="people-card">

        <div class= "profilePic">
          <img src="starterProfPic.png" height: "300" width: "300">
        </div>

        <div class= "userAbout">
          <!-- <br> -->
            <h4 class="sectionTitle">Name: <span id="name"></span></h4>
          <!--<p>
          User ID:  <span id="user-id"></span>-->
            <h4 class="sectionBody">Profession: <span id="profession"></span></h4>
            <h4 class="sectionBody">Connections: <span id="connection_count"></span></h4>
            <h4 class="sectionBody">Date Joined: <span id="date_joined"></span></h4>
            <br>
            <button id="following" onclick="follow()" hidden>Follow</button>
            <button id="unfollowing" onclick="unfollow()" hidden>Unfollow</button>
        </div>

        <div class="userConnectButton">
            <button id="connectButton">See This User's Connections</button>
        </div>
      </div>

    <!-- need to get this part to work!!! -->
    <!-- <div id="my-connections">
      <p>
        My Connection List: <span id="connection"></span>
    </div> -->
<!--    <div>
        <form>
            Enter Information to be Added to the Firestore Database:
            <input id="dataAddedByUser" type="text" name="dataForFirestore">
        </form>
    </div>-->

        <!-- ******************************************* -->

      <div id="user_history">
        <h2 class="sectionTitle" align="center"> Recent User History </h2>
        <br>

        <!-- THIS IS WHERE YOU WOULD PULL INFO FOR AN ARTICLE!!!!! DUMMY ARTICLE CODE THIS TEMPLATE

        !!!!!! BG ACCORDING TO TOPIC !!!!!!
        <div class="card text-white bg-primary" class= "article" style="max-width: 45rem;">
          <div class="card-header">!!!!!!DATE!!!!!</div>
          <div class="card-body">
            <h5 class="card-title">!!!!!! ARTICLE TITLE !!!!!!!!</h5>
            <span class="badge">!!!!! USER REACTION!!!!!</span>
            <a href=!!!!!LINK!!!!!!1!!" class="badge badge-light">Article link</a>

          </div>
      -->

        <div class="card text-white bg-primary" class= "article" style="max-width: 45rem;">
          <div class="card-header">October 28, 2019</div>
          <div class="card-body">
            <h5 class="card-title">Shooting in Sydney Raises Questions About Gun Control</h5>
            <span class="badge">Right on target</span>
            <a href="https://www.nytimes.com/2019/10/02/world/australia/sydney-shooting-gun-control.html?fbclid=IwAR03eGKFT2B4DYjDrAMo1FUk2Y3RSqoTnf6tOzvfCMhK6UyOXSyi8BWAehg" class="badge badge-light">Article link</a>

          </div>
        </div>


        <div class="card text-white bg-danger" class= "article" style="max-width: 45rem;">
          <div class="card-header ">October 27, 2019</div>
          <div class="card-body">
            <h5 class="card-title">The Health 202: Obamacare is getting more affordable under the Trump administration</h5>
            <span class="badge">Meh</span>
            <a href="https://www.washingtonpost.com/news/powerpost/paloma/the-health-202/2019/10/22/the-health-202-obamacare-is-getting-more-affordable-under-the-trump-administration/5dadf22d88e0fa3155a7128d/" class="badge badge-light">Article link</a>
          </div>
        </div>


        <div class="card text-white bg-info" class= "article" style="max-width: 45rem;">
          <div class="card-header">October 26, 2019</div>
          <div class="card-body">
            <h5 class="card-title">DeVos Held In Contempt Of Court For Enforcing Loans On Defrauded College Students</h5>
            <span class="badge">Got me thinking</span>
            <a href="https://www.npr.org/2019/10/25/773334681/devos-held-in-contempt-of-court-ed-department-fined-100-000-in-student-loan-case" class="badge badge-light">Article link</a>
          </div>
        </div>


        <div class="card text-black bg-warning" class= "article" style="max-width: 45rem;">
          <div class="card-header ">October 25, 2019</div>
          <div class="card-body">
            <h5 class="card-title">Federal judge in Chicago stops Trump administration rule aimed at denying green cards to immigrants on public benefits</h5>
            <span class="badge">Right on target</span>
            <a href="https://www.chicagotribune.com/news/breaking/ct-trump-administration-immigrant-public-aid-rule-cook-county-20191015-dg25lfeztrgjpjq22bwz5efanu-story.html?fbclid=IwAR0h_I5bb7b8ODn-MvGus9ORgkdqiT7VR3_PCfDnvSGWzammNsI86q7RvCw" class="badge badge-light">Article link</a>
          </div>
        </div>


        <div class="card text-white bg-success" class= "article" style="max-width: 45rem;">
          <div class="card-header">October 24, 2019</div>
          <div class="card-body">
            <h5 class="card-title">Is it too late to do anything about climate change?</h5>
            <span class="badge">I'm confused</span>
            <a href="https://www.bostonglobe.com/opinion/2019/10/01/too-late-anything-about-climate-change/5rmqYHZf1xi6T3dRLnmAsJ/story.html" class="badge badge-light">Article link</a>
          </div>
        </div>

    </div>


    <script>

      //sign in and out functions
      function signIn() {
        var provider = new firebase.auth.GoogleAuthProvider();
        firebase.auth().signInWithPopup(provider);
      }

      function signOut() {
        firebase.auth().signOut();
      }

      function follow() {
          var db = firebase.firestore(); //need this to access our database
          var vals = window.location.search.split("="); //split profile html to grab user's id
          //person current user wants to follow
          //var followRef = db.collection("users").doc(vals[1]);
          //current user info
          var currentUserID = firebase.auth().currentUser.uid;
          var currentUserRef = db.collection("users").doc(currentUserID);

          //const increment = firebase.firestore.FieldValue.increment(1);

//          //updating follower database
//          followRef.update({user_connections: firebase.firestore.FieldValue.arrayUnion(currentUserID)});
//          followRef.update({connection_count: increment});

          //updating current user database
          currentUserRef.update({user_connections: firebase.firestore.FieldValue.arrayUnion(vals[1])});
//          currentUserRef.update({connection_count: increment});

          db.collection("users").doc(currentUserID).onSnapshot(function (doc) {
              currentUserRef.update({connection_count: doc.data().user_connections.length});
          });
        }


      function unfollow() {
          var db = firebase.firestore(); //need this to access our database
          var vals = window.location.search.split("="); //split profile html to grab user's id
          //var followRef = db.collection("users").doc(vals[1]);
          //current user info
          var currentUserID = firebase.auth().currentUser.uid;
          var currentUserRef = db.collection("users").doc(currentUserID);
          currentUserRef.update({user_connections: firebase.firestore.FieldValue.arrayRemove(vals[1])});
          db.collection("users").doc(currentUserID).onSnapshot(function (doc) {
              currentUserRef.update({connection_count: doc.data().user_connections.length});
          });
      }


      function dailyReact(){
          //console.log("hooray!");
          var dailyReact = event.srcElement.id;
          var dailyReactDate= new Date();
          dailyAnswerGetDate =  dailyReactDate.getDate();
          dailyAnswerGetDay =  dailyReactDate.getDay();
          dailyAnswerGetYear = dailyReactDate.getFullYear()
          alert ("You reacted "+ dailyReact+ " to the article for "+ dailyReactDate); //change to "you've selected this as ur dot today!"

      }


      //where the magic happens
      document.addEventListener('DOMContentLoaded', function() {
        firebase.auth().onAuthStateChanged(authStateObserver);
        var db = firebase.firestore(); //need this to access our database

        var vals = window.location.search.split("="); //split profile html to grab user's id
        db.collection("users").doc(vals[1]).onSnapshot(function (doc) {
          document.getElementById("name").innerHTML = doc.data().username;
          //document.getElementById("user-id").innerHTML = doc.data().user_id;
          document.getElementById("profession").innerHTML = doc.data().profession;
          document.getElementById("connection_count").innerHTML = doc.data().connection_count;
          document.getElementById("date_joined").innerHTML = (doc.data().date_joined).toDate();
        });

        //trying to get the user_connections from the subcollection of user_connections
        //may have to switch to a map/array in the user's document instead
        db.collection("users").doc(vals[1]).onSnapshot(function (querySnapshot) {

            querySnapshot.data().user_connections.forEach(function(docs) {
                //document.getElementById("connection").innerHTML += "<p>" + docs + "</p>";
                document.getElementById("connection").innerHTML = "";
                db.collection("users").doc(docs).onSnapshot(function(newDoc) {
                    console.log(newDoc.data().username)
                    document.getElementById("connection").innerHTML += "<p>" + "<a href='profile.html?id="+newDoc.data().user_id+"'>" + newDoc.data().username +"</a>" + "</p>";
                });
            });

//            var connectionsArray = querySnapshot.data().user_connections;
//            document.getElementById("connection").innerHTML = connectionsArray;
        });

        /*collection("user_details").get().then(function(querySnapshot) {
          querySnapshot.forEach(function(docs) {
            // doc.data() is never undefined for query doc snapshots
            //console.log(doc.id, " => ", doc.data());
            user_info = docs.collection("user_connections");
            db.doc(user_info).onSnapshot(function(newQuerySnapshot) {
                name = newQuerySnapshot.data().username;
                document.getElementById("connection").innerHTML += "<p>" + name + "</p>";
            })
          });
        });*/

        try {
          let app = firebase.app()
          let features = ['auth', 'database', 'messaging', 'storage'] .filter(feature => typeof app[feature] === 'function');
        } catch (e) {
          console.error(e);
        }
      });

      function authStateObserver(user) {
        if (user) { // User is signed in!
          document.getElementById("sign-in").hidden = true;
          document.getElementById("sign-out").hidden = false;
          document.getElementById("connection").hidden = false;

          //personalize the welcome screen with user's name
          var currentUser = firebase.auth().currentUser.displayName;
          document.getElementById("currentUser").innerHTML = "Welcome " + currentUser;
          var profilePage = document.getElementById("profilePage");

          var db = firebase.firestore();
          document.getElementById("profilePage").hidden = false;

          var vals = window.location.search.split("="); //get user ID of other people

          //link to the user's profile - do we need this?
          db.collection("users").doc(firebase.auth().currentUser.uid).onSnapshot(function(docs) {
              profilePage.innerHTML = "<a href='profile.html?id="+docs.data().user_id+"'>" + docs.data().username +"</a>";

              var connectionsArray = docs.data().user_connections;

              if (connectionsArray.includes(vals[1])) {
                  document.getElementById("following").hidden = true;
                  document.getElementById("unfollowing").hidden = false;
              }

              else {
                document.getElementById("following").hidden = false;
                document.getElementById("unfollowing").hidden = true;
              }

          });

          /*var formData = document.getElementById("dataAddedByUser").value;
          var dbRef = db.collection("users").doc(firebase.auth().currentUser.uid);
            dbRef.update({
                username: formData,
            });
            */
          document.getElementById("people-card").hidden = false;


        } else { // User is signed out!
          document.getElementById("sign-in").hidden = false;
          document.getElementById("sign-out").hidden = true;
          document.getElementById("following").hidden = true;
          document.getElementById("unfollowing").hidden = true;
          //show generic welcome page, not customized
          document.getElementById("currentUser").innerHTML = "Welcome! Please sign in";
          document.getElementById("profilePage").hidden = true;
          document.getElementById("people-card").hidden = true;
          document.getElementById("connection").hidden = true;
        }
      }

    </script>
  </body>
</html>
